# ------------------------------------------------------------------------------------
#  GoFortress Coverage System (Streamlined)
#
#  Purpose: Process Go coverage data, generate reports and badges, deploy to GitHub Pages
#  with trend/history tracking via artifacts.
#
#  Maintainer: @mrz1836
#
# ------------------------------------------------------------------------------------

name: GoFortress (Coverage System)

on:
  workflow_call:
    inputs:
      coverage-file:
        description: "Path to coverage profile"
        required: true
        type: string
      branch-name:
        description: "Current branch name"
        required: true
        type: string
      commit-sha:
        description: "Commit SHA"
        required: true
        type: string
      env-json:
        description: "Environment configuration"
        required: true
        type: string
      primary-runner:
        description: "Primary runner OS"
        required: true
        type: string
    secrets:
      github-token:
        description: "GitHub token for API access"
        required: true

# Security: Restrictive default permissions with job-level overrides
permissions:
  contents: read

jobs:
  # ----------------------------------------------------------------------------------
  # Process Coverage and Deploy to GitHub Pages
  # ----------------------------------------------------------------------------------
  process-coverage:
    name: ğŸ“Š Process Coverage & Deploy
    runs-on: ${{ inputs.primary-runner }}
    timeout-minutes: 10
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    permissions:
      contents: write
      pages: write
      id-token: write
      statuses: write

    steps:
      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      # Setup and environment
      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      - name: ğŸ”§ Parse environment variables
        env:
          ENV_JSON: ${{ inputs.env-json }}
        run: |
          echo "$ENV_JSON" | jq -r 'to_entries | .[] | "\(.key)=\(.value)"' | while IFS='=' read -r key value; do
            echo "$key=$value" >> $GITHUB_ENV
          done

      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      # Set up Go cache paths and restore caches
      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      - name: ğŸ”§ Set Go cache paths (cross-platform)
        run: |
          echo "ğŸ”§ Setting up Go cache paths..."
          echo "GOCACHE=$HOME/.cache/go-build"        >> $GITHUB_ENV
          echo "GOMODCACHE=$HOME/go/pkg/mod"          >> $GITHUB_ENV
          echo "GOLANGCI_LINT_CACHE=$HOME/.cache/golangci-lint" >> $GITHUB_ENV

      - name: ğŸ’¾ Restore Go module cache
        id: restore-gomod
        uses: actions/cache/restore@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: ~/go/pkg/mod
          key: ${{ inputs.primary-runner }}-gomod-${{ hashFiles('**/go.sum', '.github/coverage/go.sum') }}
          restore-keys: |
            ${{ inputs.primary-runner }}-gomod-

      - name: ğŸ’¾ Restore Go build cache
        id: restore-gobuild
        uses: actions/cache/restore@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: |
            ~/.cache/go-build
            ~/.cache/go-build/test
          key: ${{ inputs.primary-runner }}-gobuild-${{ env.GO_PRIMARY_VERSION }}-${{ hashFiles('**/go.sum', '.github/coverage/go.sum') }}
          restore-keys: |
            ${{ inputs.primary-runner }}-gobuild-${{ env.GO_PRIMARY_VERSION }}-

      - name: ğŸ”§ Setup Go
        uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5.5.0
        with:
          go-version: ${{ env.GO_PRIMARY_VERSION }}
          cache: false # we handle caches ourselves

      - name: ğŸ”¨ Build coverage tool
        working-directory: .github/coverage/cmd/gofortress-coverage
        run: |
          go build -v -o gofortress-coverage .
          chmod +x gofortress-coverage

      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      # Download and restore coverage history (WORKING SYSTEM - PRESERVED)
      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      - name: ğŸ“¥ Download previous coverage history
        if: github.event_name == 'push' && inputs.branch-name == 'master'
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT_TOKEN != '' && secrets.GH_PAT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ“¥ Downloading previous coverage history using GitHub API..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # Create history artifacts directory
          mkdir -p .github/coverage/history-artifacts/
          echo "ğŸ“ Created history artifacts directory"

          # Check GitHub CLI availability and authentication
          if ! command -v gh &> /dev/null; then
            echo "âŒ GitHub CLI (gh) is not available"
            echo "â„¹ï¸ Skipping history download - this will not affect coverage processing"
            exit 0
          fi

          if ! gh auth status &> /dev/null; then
            echo "âŒ GitHub CLI is not authenticated"
            echo "â„¹ï¸ Skipping history download - this will not affect coverage processing"
            exit 0
          fi

          echo "âœ… GitHub CLI is available and authenticated"

          # Get recent successful workflow runs from master branch
          echo "ğŸ” Fetching recent successful workflow runs from master branch..."
          WORKFLOW_RUNS=$(gh api repos/${{ github.repository }}/actions/runs \
            --jq '.workflow_runs[] | select(.status == "completed" and .conclusion == "success" and .head_branch == "master") | .id' \
            --paginate 2>/dev/null | head -5 || echo "")

          if [[ -z "$WORKFLOW_RUNS" ]]; then
            echo "â„¹ï¸ No recent successful workflow runs found"
            echo "ğŸ“ This is normal for:"
            echo "  - First run on this repository"
            echo "  - First successful run after setup"
            echo "  - GitHub API rate limiting or connectivity issues"
            exit 0
          fi

          echo "ğŸ“Š Found $(echo "$WORKFLOW_RUNS" | wc -l) recent successful runs"
          echo "ğŸ“‹ Workflow run IDs: $(echo "$WORKFLOW_RUNS" | tr '\n' ' ')"

          # Download coverage history artifacts from recent runs
          DOWNLOADED_COUNT=0
          MAX_ARTIFACTS=3

          for run_id in $WORKFLOW_RUNS; do
            if [[ $DOWNLOADED_COUNT -ge $MAX_ARTIFACTS ]]; then
              echo "ğŸ“Š Reached maximum artifact limit ($MAX_ARTIFACTS), stopping download"
              break
            fi
            
            echo ""
            echo "ğŸ” Checking run $run_id for coverage history artifacts..."
            
            ARTIFACTS=$(gh api repos/${{ github.repository }}/actions/runs/$run_id/artifacts \
              --jq '.artifacts[] | select(.name | startswith("coverage-history-")) | .archive_download_url' \
              2>/dev/null || echo "")
            
            if [[ -n "$ARTIFACTS" ]]; then
              echo "âœ… Found coverage history artifacts in run $run_id"
              
              echo "$ARTIFACTS" | while read -r download_url; do
                if [[ -n "$download_url" ]]; then
                  echo "ğŸ“¥ Downloading artifact from: $download_url"
                  cd .github/coverage/history-artifacts/
                  
                  # Download with detailed logging
                  DOWNLOAD_SUCCESS=false
                  for attempt in 1 2 3; do
                    echo "    ğŸ“¥ Download attempt $attempt/3..."
                    if curl -L -H "Authorization: Bearer $GITHUB_TOKEN" \
                            -H "Accept: application/vnd.github+json" \
                            --max-time 30 --connect-timeout 10 \
                            "$download_url" -o "history-$run_id.zip" 2>/dev/null; then
                      if [[ -s "history-$run_id.zip" ]]; then
                        echo "    âœ… Download successful ($(wc -c < "history-$run_id.zip") bytes)"
                        DOWNLOAD_SUCCESS=true
                        break
                      else
                        echo "    âš ï¸ Downloaded file is empty"
                        rm -f "history-$run_id.zip"
                      fi
                    else
                      echo "    âš ï¸ Download attempt $attempt failed"
                      rm -f "history-$run_id.zip"
                    fi
                    
                    if [[ $attempt -lt 3 ]]; then
                      echo "    â³ Waiting 2 seconds before retry..."
                      sleep 2
                    fi
                  done
                  
                  if [[ "$DOWNLOAD_SUCCESS" == "true" ]]; then
                    if unzip -q "history-$run_id.zip" 2>/dev/null; then
                      rm -f "history-$run_id.zip"
                      echo "    âœ… Extracted history from run $run_id"
                      
                      # Show what was extracted
                      EXTRACTED_FILES=$(find . -name "*.json" -newer "history-$run_id.zip" 2>/dev/null | wc -l || echo "0")
                      echo "    ğŸ“„ Extracted $EXTRACTED_FILES JSON files"
                    else
                      echo "    âš ï¸ Failed to extract history-$run_id.zip (possibly corrupted)"
                      rm -f "history-$run_id.zip"
                    fi
                  else
                    echo "    âŒ Failed to download after 3 attempts"
                  fi
                  
                  cd - > /dev/null
                fi
              done
              DOWNLOADED_COUNT=$((DOWNLOADED_COUNT + 1))
            else
              echo "â„¹ï¸ No coverage history artifacts found in run $run_id"
            fi
          done

          if [[ $DOWNLOADED_COUNT -gt 0 ]]; then
            echo ""
            echo "âœ… Successfully downloaded $DOWNLOADED_COUNT coverage history artifacts"
            
            # Show summary of downloaded files
            TOTAL_JSON_FILES=$(find .github/coverage/history-artifacts -name "*.json" -type f 2>/dev/null | wc -l || echo "0")
            echo "ğŸ“Š Total JSON files downloaded: $TOTAL_JSON_FILES"
            
            if [[ $TOTAL_JSON_FILES -gt 0 ]]; then
              echo "ğŸ“‹ Downloaded files:"
              find .github/coverage/history-artifacts -name "*.json" -type f -exec basename {} \; | head -10
            fi
          else
            echo "â„¹ï¸ No coverage history artifacts available from previous runs"
            echo "ğŸ“ This is normal for the first few runs of the coverage system"
          fi

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        continue-on-error: true

      - name: ğŸ”„ Restore history from artifacts
        if: github.event_name == 'push' && inputs.branch-name == 'master'
        run: |
          echo "ğŸ”„ Restoring coverage history from artifacts..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # Create history directory
          HISTORY_DIR=".github/coverage/history"
          mkdir -p "$HISTORY_DIR"
          echo "ğŸ“ Created history directory: $HISTORY_DIR"

          # Check if artifacts were downloaded
          ARTIFACTS_DIR=".github/coverage/history-artifacts"
          if [[ -d "$ARTIFACTS_DIR" ]]; then
            echo "âœ… Artifacts directory found: $ARTIFACTS_DIR"
            
            # Show available artifacts
            echo "ğŸ“‹ Contents of artifacts directory:"
            ls -la "$ARTIFACTS_DIR" || echo "Unable to list directory"
            
            # Count available JSON files
            ARTIFACT_FILES=$(find "$ARTIFACTS_DIR" -name "*.json" -type f 2>/dev/null | wc -l || echo "0")
            echo "ğŸ“¦ Found $ARTIFACT_FILES JSON files in artifacts"
            
            if [[ $ARTIFACT_FILES -gt 0 ]]; then
              echo ""
              echo "ğŸ”„ Starting file restoration process..."
              
              # List all JSON files found
              echo "ğŸ“‹ JSON files to be restored:"
              find "$ARTIFACTS_DIR" -name "*.json" -type f -exec echo "  - {}" \; 2>/dev/null
              
              # Copy files with detailed logging
              COPY_SUCCESS=0
              COPY_FAILED=0
              
              find "$ARTIFACTS_DIR" -name "*.json" -type f | while read -r file; do
                filename=$(basename "$file")
                destination="$HISTORY_DIR/$filename"
                
                if cp "$file" "$destination" 2>/dev/null; then
                  echo "  âœ… Copied: $filename"
                  COPY_SUCCESS=$((COPY_SUCCESS + 1))
                else
                  echo "  âŒ Failed to copy: $filename"
                  COPY_FAILED=$((COPY_FAILED + 1))
                fi
              done
              
              echo ""
              echo "âœ… File restoration completed"
            else
              echo "â„¹ï¸ No JSON files found in artifacts directory"
            fi
          else
            echo "â„¹ï¸ No artifacts directory found - this is normal for first run"
          fi

          # Verify restoration results
          HISTORY_COUNT=$(find "$HISTORY_DIR" -name "*.json" -type f 2>/dev/null | wc -l || echo "0")
          echo ""
          echo "ğŸ“Š History restoration summary:"
          echo "  - History directory: $HISTORY_DIR"
          echo "  - Total history files: $HISTORY_COUNT"

          if [[ $HISTORY_COUNT -gt 0 ]]; then
            echo "  - History files available for trend analysis: âœ…"
            echo "ğŸ“‹ Restored history files (newest first):"
            find "$HISTORY_DIR" -name "*.json" -type f -exec basename {} \; | sort -r | head -5
            
            # Show disk usage
            HISTORY_SIZE=$(du -sh "$HISTORY_DIR" 2>/dev/null | cut -f1 || echo "unknown")
            echo "  - Total history size: $HISTORY_SIZE"
          else
            echo "  - History files available: âŒ (first run or no previous data)"
          fi

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      # Download coverage artifact and process
      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      - name: ğŸ“¥ Download coverage artifact
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: coverage-data
          path: ./coverage-artifacts/
        continue-on-error: true

      - name: ğŸ“Š Process coverage data
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT_TOKEN != '' && secrets.GH_PAT_TOKEN || secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_SHA: ${{ inputs.commit-sha }}
          GITHUB_REF_NAME: ${{ inputs.branch-name }}
          COVERAGE_HISTORY_PATH: ${{ github.workspace }}/.github/coverage/history
        working-directory: .github/coverage/cmd/gofortress-coverage
        run: |
          echo "ğŸ“Š Processing coverage data with complete pipeline..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # Debug: Show current working directory and paths
          echo "ğŸ” Environment information:"
          echo "  - Current working directory: $(pwd)"
          echo "  - Repository root should be: $(realpath ../../../../)"
          echo "  - History path from env: $COVERAGE_HISTORY_PATH"
          echo "  - GitHub repository: $GITHUB_REPOSITORY"
          echo "  - Branch: $GITHUB_REF_NAME"
          echo "  - Commit SHA: $GITHUB_SHA"

          # Find coverage file with detailed logging
          REPO_ROOT="$(realpath ../../../../)"
          echo ""
          echo "ğŸ” Locating coverage input file..."
          echo "  - Repository root: $REPO_ROOT"
          echo "  - Looking for: ${{ inputs.coverage-file }}"

          COVERAGE_FILE=""
          COVERAGE_LOCATIONS=(
            "$REPO_ROOT/coverage-artifacts/${{ inputs.coverage-file }}"
            "$REPO_ROOT/${{ inputs.coverage-file }}"
          )

          for location in "${COVERAGE_LOCATIONS[@]}"; do
            echo "  - Checking: $location"
            if [[ -f "$location" ]]; then
              COVERAGE_FILE="$location"
              FILE_SIZE=$(wc -c < "$COVERAGE_FILE" 2>/dev/null || echo "unknown")
              echo "    âœ… Found ($FILE_SIZE bytes)"
              break
            else
              echo "    âŒ Not found"
            fi
          done

          if [[ -z "$COVERAGE_FILE" ]]; then
            echo ""
            echo "âŒ Coverage file not found: ${{ inputs.coverage-file }}"
            echo "ğŸ” Available files in coverage-artifacts:"
            ls -la "$REPO_ROOT/coverage-artifacts/" 2>/dev/null || echo "No coverage-artifacts directory"
            echo "ğŸ” Available files in repository root:"
            ls -la "$REPO_ROOT"/*.out "$REPO_ROOT"/*.txt 2>/dev/null || echo "No .out or .txt files in root"
            exit 1
          fi

          echo "âœ… Using coverage file: $COVERAGE_FILE"

          # Create clean output directory with logging
          OUTPUT_DIR="$REPO_ROOT/pages-deploy"
          echo ""
          echo "ğŸ”§ Preparing output directory..."
          echo "  - Output directory: $OUTPUT_DIR"

          if [[ -d "$OUTPUT_DIR" ]]; then
            echo "  - Cleaning existing directory..."
            rm -rf "$OUTPUT_DIR"
          fi

          mkdir -p "$OUTPUT_DIR/data"
          echo "  - Created output directory structure"
          echo "  - Created data subdirectory for JSON files"

          # Show history availability for trend analysis
          HISTORY_DIR="$REPO_ROOT/.github/coverage/history"
          HISTORY_COUNT=$(find "$HISTORY_DIR" -name "*.json" -type f 2>/dev/null | wc -l || echo "0")
          echo ""
          echo "ğŸ“ˆ History availability for trend analysis:"
          echo "  - History directory: $HISTORY_DIR"
          echo "  - Available history files: $HISTORY_COUNT"
          if [[ $HISTORY_COUNT -gt 0 ]]; then
            echo "  - Trend analysis: âœ… Enabled"
            echo "  - Recent history files:"
            find "$HISTORY_DIR" -name "*.json" -type f -exec basename {} \; | sort -r | head -3 | sed 's/^/    - /'
          else
            echo "  - Trend analysis: âš ï¸ No history available (first run)"
          fi

          # Process coverage with complete command
          echo ""
          echo "ğŸš€ Running GoFortress coverage complete command..."
          echo "  Command: ./gofortress-coverage complete --input \"$COVERAGE_FILE\" --output \"$OUTPUT_DIR\""

          if ./gofortress-coverage complete \
            --input "$COVERAGE_FILE" \
            --output "$OUTPUT_DIR"; then
            echo "âœ… Coverage processing completed successfully"
          else
            echo "âŒ Coverage processing failed"
            exit 1
          fi

          # Verify outputs were created
          echo ""
          echo "ğŸ” Verifying generated outputs..."
          EXPECTED_FILES=("index.html" "coverage.html" "coverage.svg" "reports/branch/${{ inputs.branch-name }}/data/build-status.json")

          ALL_GENERATED=true
          for file in "${EXPECTED_FILES[@]}"; do
            if [[ -f "$OUTPUT_DIR/$file" ]]; then
              FILE_SIZE=$(wc -c < "$OUTPUT_DIR/$file" 2>/dev/null || echo "unknown")
              echo "  âœ… $file ($FILE_SIZE bytes)"
            else
              echo "  âŒ MISSING: $file"
              ALL_GENERATED=false
            fi
          done

          if [[ "$ALL_GENERATED" != "true" ]]; then
            echo ""
            echo "âŒ Some expected files were not generated"
            echo "ğŸ” All files in output directory:"
            find "$OUTPUT_DIR" -type f -exec echo "  - {}" \;
            exit 1
          fi

          # Show processing summary
          TOTAL_FILES=$(find "$OUTPUT_DIR" -type f | wc -l)
          OUTPUT_SIZE=$(du -sh "$OUTPUT_DIR" 2>/dev/null | cut -f1 || echo "unknown")

          echo ""
          echo "ğŸ“Š Processing summary:"
          echo "  - Total files generated: $TOTAL_FILES"
          echo "  - Total output size: $OUTPUT_SIZE"
          echo "  - Output directory: $OUTPUT_DIR"

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: ğŸ“ˆ Record coverage history
        if: github.event_name == 'push' && inputs.branch-name == 'master'
        env:
          COVERAGE_HISTORY_PATH: ${{ github.workspace }}/.github/coverage/history
        working-directory: .github/coverage/cmd/gofortress-coverage
        run: |
          echo "ğŸ“ˆ Recording coverage history..."

          # Find coverage file
          REPO_ROOT="$(realpath ../../../../)"
          if [[ -f "$REPO_ROOT/coverage-artifacts/${{ inputs.coverage-file }}" ]]; then
            COVERAGE_FILE="$REPO_ROOT/coverage-artifacts/${{ inputs.coverage-file }}"
          elif [[ -f "$REPO_ROOT/${{ inputs.coverage-file }}" ]]; then
            COVERAGE_FILE="$REPO_ROOT/${{ inputs.coverage-file }}"
          else
            echo "âš ï¸ Coverage file not found for history recording"
            exit 0
          fi

          # Record coverage in history
          ./gofortress-coverage history \
            --add "$COVERAGE_FILE" \
            --branch "${{ inputs.branch-name }}" \
            --commit "${{ inputs.commit-sha }}" \
            --format text

          echo "âœ… History recording completed"

      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      # Prepare for GitHub Pages deployment
      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      - name: ğŸ”§ Prepare GitHub Pages deployment
        run: |
          echo "ğŸ”§ Preparing GitHub Pages deployment..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          DEPLOY_DIR="pages-deploy"
          echo "ğŸ“ Deployment directory: $DEPLOY_DIR"

          # Verify deployment directory exists
          if [[ ! -d "$DEPLOY_DIR" ]]; then
            echo "âŒ Deployment directory does not exist: $DEPLOY_DIR"
            echo "ğŸ” This suggests coverage processing failed"
            exit 1
          fi

          echo "âœ… Deployment directory found"

          # Add .nojekyll to disable Jekyll processing (CRITICAL FIX)
          echo ""
          echo "ğŸ”§ Adding .nojekyll file to disable Jekyll processing..."
          touch "$DEPLOY_DIR/.nojekyll"

          if [[ -f "$DEPLOY_DIR/.nojekyll" ]]; then
            echo "âœ… .nojekyll file created successfully"
            echo "ğŸ“ This disables Jekyll processing that was filtering out coverage files"
          else
            echo "âŒ Failed to create .nojekyll file"
            exit 1
          fi

          # Show complete directory structure before deployment
          echo ""
          echo "ğŸŒ³ Complete deployment directory structure:"
          find "$DEPLOY_DIR" -type f -exec ls -la {} \; | sort
          echo ""

          # Verify critical files exist with detailed reporting
          CRITICAL_FILES=("index.html" "coverage.html" "coverage.svg" "reports/branch/${{ inputs.branch-name }}/data/build-status.json" ".nojekyll")
          echo "ğŸ¯ Verifying critical files for GitHub Pages:"

          ALL_EXIST=true
          for file in "${CRITICAL_FILES[@]}"; do
            if [[ -f "$DEPLOY_DIR/$file" ]]; then
              FILE_SIZE=$(wc -c < "$DEPLOY_DIR/$file" 2>/dev/null || echo "unknown")
              echo "  âœ… $file ($FILE_SIZE bytes)"
              
              # Show content preview for important files
              if [[ "$file" == "data/build-status.json" ]]; then
                echo "    ğŸ“‹ Content preview:"
                head -3 "$DEPLOY_DIR/$file" | sed 's/^/      /'
              fi
            else
              echo "  âŒ MISSING: $file"
              ALL_EXIST=false
            fi
          done

          if [[ "$ALL_EXIST" != "true" ]]; then
            echo ""
            echo "âŒ Missing critical files for deployment"
            echo "ğŸ” This will cause 404 errors on the deployed site"
            echo "ğŸš¨ Available files in deployment directory:"
            find "$DEPLOY_DIR" -type f -exec echo "  - {}" \;
            exit 1
          fi

          # File analysis by type
          echo ""
          echo "ğŸ“‹ File analysis by type:"
          echo "  HTML files:"
          find "$DEPLOY_DIR" -name "*.html" -exec echo "    - {}" \;
          echo "  JSON files:"
          find "$DEPLOY_DIR" -name "*.json" -exec echo "    - {}" \;
          echo "  SVG files:"
          find "$DEPLOY_DIR" -name "*.svg" -exec echo "    - {}" \;
          echo "  Jekyll control files:"
          find "$DEPLOY_DIR" -name ".nojekyll" -exec echo "    - {}" \;

          # Deployment summary
          TOTAL_FILES=$(find "$DEPLOY_DIR" -type f | wc -l)
          TOTAL_SIZE=$(du -sh "$DEPLOY_DIR" 2>/dev/null | cut -f1 || echo "unknown")

          echo ""
          echo "ğŸ“Š Deployment summary:"
          echo "  - Total files to deploy: $TOTAL_FILES"
          echo "  - Total deployment size: $TOTAL_SIZE"
          echo "  - Jekyll processing: âŒ DISABLED (.nojekyll present)"
          echo "  - Expected URLs after deployment:"
          echo "    - https://mrz1836.github.io/go-broadcast/ (dashboard)"
          echo "    - https://mrz1836.github.io/go-broadcast/coverage.html (detailed report)"
          echo "    - https://mrz1836.github.io/go-broadcast/data/build-status.json (build status)"
          echo "    - https://mrz1836.github.io/go-broadcast/coverage.svg (coverage badge)"

          echo ""
          echo "âœ… Deployment directory prepared and verified"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      # Deploy to GitHub Pages
      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      - name: ğŸ“¤ Upload Pages artifact
        if: github.event_name == 'push' && inputs.branch-name == 'master'
        uses: actions/upload-pages-artifact@56afc609e74202658d3ffba0e8f6dda462b719fa # v3.0.1
        with:
          path: pages-deploy

      - name: ğŸš€ Deploy to GitHub Pages
        if: github.event_name == 'push' && inputs.branch-name == 'master'
        id: deployment
        uses: actions/deploy-pages@d6db90164ac5ed86f2b6aed7e0febac5b3c0c03e # v4.0.5

      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      # Test deployed URLs (30 second timeout max)
      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      - name: ğŸ” Test deployed URLs
        if: github.event_name == 'push' && inputs.branch-name == 'master'
        run: |
          echo "ğŸ” Testing deployed URLs..."

          BASE_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"

          # URLs to test
          URLS=(
            "$BASE_URL/"
            "$BASE_URL/index.html"
            "$BASE_URL/coverage.html"
            "$BASE_URL/coverage.svg"
            "$BASE_URL/data/build-status.json"
          )

          echo "ğŸŒ Base URL: $BASE_URL"
          echo "â³ Waiting 30 seconds for deployment to propagate..."
          sleep 30

          SUCCESS_COUNT=0
          TOTAL_COUNT=${#URLS[@]}

          for url in "${URLS[@]}"; do
            echo ""
            echo "ğŸ”— Testing: $url"
            
            # Test with 3 attempts, 10 second intervals
            HTTP_STATUS=""
            for attempt in 1 2 3; do
              HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 5 --max-time 10 "$url" 2>/dev/null || echo "000")
              
              if [[ "$HTTP_STATUS" == "200" ]]; then
                echo "  âœ… SUCCESS ($HTTP_STATUS)"
                SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
                break
              else
                echo "  âŒ FAILED ($HTTP_STATUS)"
                if [[ $attempt -lt 3 ]]; then
                  echo "  â³ Retrying in 5 seconds..."
                  sleep 5
                fi
              fi
            done
          done

          echo ""
          echo "ğŸ“Š RESULTS:"
          echo "  - Successful URLs: $SUCCESS_COUNT/$TOTAL_COUNT"
          echo "  - Success rate: $((SUCCESS_COUNT * 100 / TOTAL_COUNT))%"

          if [[ $SUCCESS_COUNT -eq $TOTAL_COUNT ]]; then
            echo "ğŸ‰ ALL URLS WORKING! Deployment successful."
            echo ""
            echo "ğŸŒ Live Coverage Dashboard: $BASE_URL/"
            echo "ğŸ“Š Live Coverage Report: $BASE_URL/coverage.html"
            echo "ğŸ·ï¸ Live Coverage Badge: $BASE_URL/coverage.svg"
            echo "ğŸ“ˆ Live Build Status: $BASE_URL/data/build-status.json"
          else
            echo "âŒ DEPLOYMENT VERIFICATION FAILED"
            echo "ğŸš¨ Not all URLs are accessible - failing workflow"
            exit 1
          fi

      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      # Collect cache statistics
      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      - name: ğŸ“Š Collect cache statistics
        id: cache-stats
        if: always()
        run: |
          echo "ğŸ“Š Collecting cache statistics..."

          # Get cache hit information
          GOMOD_HIT="${{ steps.restore-gomod.outputs.cache-hit }}"
          GOBUILD_HIT="${{ steps.restore-gobuild.outputs.cache-hit }}"

          # Get cache sizes
          GOMOD_SIZE="0B"
          GOBUILD_SIZE="0B"

          if [ -d "$HOME/go/pkg/mod" ]; then
            GOMOD_SIZE=$(du -sh "$HOME/go/pkg/mod" 2>/dev/null | cut -f1 || echo "0B")
          fi

          if [ -d "$HOME/.cache/go-build" ]; then
            GOBUILD_SIZE=$(du -sh "$HOME/.cache/go-build" 2>/dev/null | cut -f1 || echo "0B")
          fi

          # Create cache statistics JSON
          cat > "cache-stats-coverage.json" << 'EOF'
          {
            "os": "${{ inputs.primary-runner }}",
            "go_version": "${{ env.GO_PRIMARY_VERSION }}",
            "gomod_cache_hit": "$GOMOD_HIT",
            "gobuild_cache_hit": "$GOBUILD_HIT",
            "cache_size_gomod": "$GOMOD_SIZE",
            "cache_size_gobuild": "$GOBUILD_SIZE",
            "workflow": "coverage",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF

          echo "ğŸ“Š Cache statistics collected"

      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      # Upload cache statistics
      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      - name: ğŸ“¤ Upload cache statistics
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: cache-stats-coverage
          path: cache-stats-coverage.json
          retention-days: 1

      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      # Upload coverage history for future runs (WORKING SYSTEM - PRESERVED)
      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      - name: ğŸ“¤ Upload coverage history artifacts
        if: github.event_name == 'push' && inputs.branch-name == 'master'
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: coverage-history-${{ inputs.commit-sha }}
          path: .github/coverage/history/*.json
          retention-days: 90
          compression-level: 9
        continue-on-error: true
